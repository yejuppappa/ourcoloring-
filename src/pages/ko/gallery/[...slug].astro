---
export const prerender = false;

import Layout from "@/layouts/Layout.astro";
import DrawingCard from "@/components/gallery/DrawingCard.astro";
import GalleryGrid from "@/components/gallery/GalleryGrid.astro";
import { t } from "@/i18n";
import type { Category, Subcategory, Drawing, DrawingWithMeta } from "@/lib/db/types";

const locale = "ko";
const i18n = t(locale);
const g = i18n.gallery;

const runtime = Astro.locals.runtime;
const DB = runtime.env.DB;

const slugParts = Astro.params.slug ? Astro.params.slug.split("/").filter(Boolean) : [];
const R2_URL = "https://images.ourcoloring.com";

// Route: /ko/gallery/ → Gallery landing
// Route: /ko/gallery/play/ → Category page
// Route: /ko/gallery/play/dinosaur/ → Subcategory page
// Route: /ko/gallery/play/dinosaur/cute-dino-01/ → Drawing page

let pageType: "landing" | "category" | "subcategory" | "drawing" = "landing";
let category: Category | null = null;
let subcategory: Subcategory | null = null;
let drawing: DrawingWithMeta | null = null;
let categories: Category[] = [];
let subcategories: (Subcategory & { drawing_count: number })[] = [];
let drawings: Drawing[] = [];
let relatedDrawings: Drawing[] = [];
let totalDrawings = 0;
let pageTitle = g.title;
let pageDescription = g.subtitle;

try {
  if (slugParts.length === 0) {
    // Gallery landing
    pageType = "landing";
    const { results } = await DB.prepare(
      `SELECT c.*, COUNT(d.id) as drawing_count
       FROM categories c
       LEFT JOIN subcategories s ON c.id = s.category_id
       LEFT JOIN drawings d ON s.id = d.subcategory_id AND d.is_published = 1
       GROUP BY c.id ORDER BY c.sort_order`
    ).all<Category & { drawing_count: number }>();
    categories = results;

  } else if (slugParts.length === 1) {
    // Category page
    pageType = "category";
    category = await DB.prepare("SELECT * FROM categories WHERE slug = ?")
      .bind(slugParts[0]).first<Category>();

    if (!category) return Astro.redirect(`/${locale}/gallery/`);

    const { results } = await DB.prepare(
      `SELECT s.*, COUNT(d.id) as drawing_count
       FROM subcategories s
       LEFT JOIN drawings d ON s.id = d.subcategory_id AND d.is_published = 1
       WHERE s.category_id = ?
       GROUP BY s.id ORDER BY s.sort_order`
    ).bind(category.id).all<Subcategory & { drawing_count: number }>();
    subcategories = results;

    pageTitle = `${category.name_ko} | ${g.title}`;
    pageDescription = category.description_ko || g.subtitle;

  } else if (slugParts.length === 2) {
    // Subcategory page
    pageType = "subcategory";
    category = await DB.prepare("SELECT * FROM categories WHERE slug = ?")
      .bind(slugParts[0]).first<Category>();
    if (!category) return Astro.redirect(`/${locale}/gallery/`);

    subcategory = await DB.prepare(
      "SELECT * FROM subcategories WHERE category_id = ? AND slug = ?"
    ).bind(category.id, slugParts[1]).first<Subcategory>();
    if (!subcategory) return Astro.redirect(`/${locale}/gallery/${slugParts[0]}/`);

    const countResult = await DB.prepare(
      "SELECT COUNT(*) as count FROM drawings WHERE subcategory_id = ? AND is_published = 1"
    ).bind(subcategory.id).first<{ count: number }>();
    totalDrawings = countResult?.count || 0;

    const { results } = await DB.prepare(
      `SELECT * FROM drawings WHERE subcategory_id = ? AND is_published = 1
       ORDER BY created_at DESC LIMIT 50`
    ).bind(subcategory.id).all<Drawing>();
    drawings = results;

    pageTitle = `${subcategory.name_ko} ${g.title} | OurColoring`;
    pageDescription = subcategory.description_ko || `${subcategory.name_ko} 색칠공부 도안 무료 다운로드`;

  } else if (slugParts.length === 3) {
    // Drawing page
    pageType = "drawing";
    category = await DB.prepare("SELECT * FROM categories WHERE slug = ?")
      .bind(slugParts[0]).first<Category>();
    if (!category) return Astro.redirect(`/${locale}/gallery/`);

    subcategory = await DB.prepare(
      "SELECT * FROM subcategories WHERE category_id = ? AND slug = ?"
    ).bind(category.id, slugParts[1]).first<Subcategory>();
    if (!subcategory) return Astro.redirect(`/${locale}/gallery/${slugParts[0]}/`);

    const d = await DB.prepare(
      "SELECT * FROM drawings WHERE subcategory_id = ? AND slug = ? AND is_published = 1"
    ).bind(subcategory.id, slugParts[2]).first<Drawing>();
    if (!d) return Astro.redirect(`/${locale}/gallery/${slugParts[0]}/${slugParts[1]}/`);

    drawing = {
      ...d,
      category_slug: category.slug,
      category_name_ko: category.name_ko,
      category_name_en: category.name_en,
      subcategory_slug: subcategory.slug,
      subcategory_name_ko: subcategory.name_ko,
      subcategory_name_en: subcategory.name_en,
    } as DrawingWithMeta;

    const { results } = await DB.prepare(
      `SELECT * FROM drawings WHERE subcategory_id = ? AND id != ? AND is_published = 1
       ORDER BY download_count DESC LIMIT 4`
    ).bind(subcategory.id, d.id).all<Drawing>();
    relatedDrawings = results;

    pageTitle = `${d.name_ko} 색칠공부 도안 | OurColoring`;
    pageDescription = d.description_ko || `${d.name_ko} 색칠공부 도안을 무료로 다운로드하세요.`;

  } else {
    return Astro.redirect(`/${locale}/gallery/`);
  }
} catch (e) {
  console.error("Gallery error:", e);
}

const diffLabels: Record<string, string> = { easy: "쉬움", medium: "보통", hard: "어려움" };
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="mx-auto max-w-6xl px-4 py-8">

    {/* ═══ Gallery Landing ═══ */}
    {pageType === "landing" && (
      <div>
        <div class="text-center mb-10">
          <h1 class="font-['Nunito'] text-3xl font-extrabold text-[#3D3530] md:text-4xl">{g.title}</h1>
          <p class="mt-3 text-[#7A7067]">{g.subtitle}</p>
        </div>

        {categories.length === 0 ? (
          <div class="text-center py-16">
            <p class="text-lg text-[#7A7067]">{g.noDrawings}</p>
            <p class="mt-2 text-[#A09890]">{g.comingSoon}</p>
            <a href={`/${locale}/#converter`} class="mt-6 inline-block rounded-2xl bg-gradient-to-r from-[#FF6B4A] to-[#FF8F6B] px-8 py-3 font-bold text-white shadow-lg">
              {g.goToConvert}
            </a>
          </div>
        ) : (
          <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
            {categories.map((cat: any) => (
              <a
                href={`/${locale}/gallery/${cat.slug}/`}
                class="group block rounded-2xl bg-white p-6 shadow-sm ring-1 ring-[#E8DFD6] transition-all duration-200 hover:shadow-lg hover:-translate-y-1"
              >
                <div class="text-4xl mb-4">{cat.icon}</div>
                <h2 class="text-xl font-bold text-[#3D3530] group-hover:text-[#FF6B4A] transition-colors">
                  {cat.name_ko}
                </h2>
                <p class="mt-2 text-sm text-[#7A7067]">{cat.description_ko}</p>
                <p class="mt-3 text-sm font-medium text-[#FF6B4A]">
                  {cat.drawing_count || 0}{g.drawings} →
                </p>
              </a>
            ))}
          </div>
        )}
      </div>
    )}

    {/* ═══ Category Page ═══ */}
    {pageType === "category" && category && (
      <div>
        {/* Breadcrumb */}
        <nav class="mb-6 text-sm text-[#A09890]">
          <a href={`/${locale}/gallery/`} class="hover:text-[#FF6B4A]">{g.title}</a>
          <span class="mx-2">›</span>
          <span class="text-[#3D3530]">{category.name_ko}</span>
        </nav>

        <div class="mb-8">
          <h1 class="font-['Nunito'] text-2xl font-extrabold text-[#3D3530] md:text-3xl">
            {category.icon} {category.name_ko}
          </h1>
          <p class="mt-2 text-[#7A7067]">{category.description_ko}</p>
        </div>

        {subcategories.length === 0 ? (
          <div class="text-center py-12 text-[#A09890]">{g.comingSoon}</div>
        ) : (
          <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4">
            {subcategories.map((sub: any) => (
              <a
                href={`/${locale}/gallery/${category!.slug}/${sub.slug}/`}
                class="group block rounded-xl bg-white p-5 shadow-sm ring-1 ring-[#E8DFD6] transition-all hover:shadow-md hover:-translate-y-0.5"
              >
                <h3 class="font-bold text-[#3D3530] group-hover:text-[#FF6B4A] transition-colors">
                  {sub.name_ko}
                </h3>
                <p class="mt-1 text-sm text-[#A09890]">
                  {sub.drawing_count || 0}{g.drawings}
                </p>
              </a>
            ))}
          </div>
        )}
      </div>
    )}

    {/* ═══ Subcategory Page ═══ */}
    {pageType === "subcategory" && category && subcategory && (
      <div>
        {/* Breadcrumb */}
        <nav class="mb-6 text-sm text-[#A09890]">
          <a href={`/${locale}/gallery/`} class="hover:text-[#FF6B4A]">{g.title}</a>
          <span class="mx-2">›</span>
          <a href={`/${locale}/gallery/${category.slug}/`} class="hover:text-[#FF6B4A]">{category.name_ko}</a>
          <span class="mx-2">›</span>
          <span class="text-[#3D3530]">{subcategory.name_ko}</span>
        </nav>

        <div class="mb-8">
          <h1 class="font-['Nunito'] text-2xl font-extrabold text-[#3D3530] md:text-3xl">
            {subcategory.name_ko} {g.title}
          </h1>
          <p class="mt-2 text-sm text-[#A09890]">{totalDrawings}{g.drawings}</p>
        </div>

        {drawings.length === 0 ? (
          <div class="text-center py-12">
            <p class="text-[#7A7067]">{g.noDrawings}</p>
            <p class="mt-2 text-sm text-[#A09890]">{g.comingSoon}</p>
          </div>
        ) : (
          <GalleryGrid>
            {drawings.map((d: Drawing) => (
              <DrawingCard
                slug={d.slug}
                name={d.name_ko}
                thumbnailKey={d.thumbnail_key}
                difficulty={d.difficulty}
                categorySlug={category!.slug}
                subcategorySlug={subcategory!.slug}
                locale={locale}
              />
            ))}
          </GalleryGrid>
        )}
      </div>
    )}

    {/* ═══ Drawing Page ═══ */}
    {pageType === "drawing" && drawing && category && subcategory && (
      <div>
        {/* Breadcrumb */}
        <nav class="mb-6 text-sm text-[#A09890]">
          <a href={`/${locale}/gallery/`} class="hover:text-[#FF6B4A]">{g.title}</a>
          <span class="mx-2">›</span>
          <a href={`/${locale}/gallery/${category.slug}/`} class="hover:text-[#FF6B4A]">{category.name_ko}</a>
          <span class="mx-2">›</span>
          <a href={`/${locale}/gallery/${category.slug}/${subcategory.slug}/`} class="hover:text-[#FF6B4A]">{subcategory.name_ko}</a>
          <span class="mx-2">›</span>
          <span class="text-[#3D3530]">{drawing.name_ko}</span>
        </nav>

        <div class="grid grid-cols-1 gap-8 lg:grid-cols-[1fr_320px]">
          {/* Main image */}
          <div>
            <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-[#E8DFD6]">
              <img
                src={`${R2_URL}/${drawing.image_key}`}
                alt={`${drawing.name_ko} 색칠공부 도안`}
                class="w-full rounded-lg"
              />
            </div>
          </div>

          {/* Sidebar info */}
          <div class="space-y-6">
            <div>
              <h1 class="font-['Nunito'] text-2xl font-extrabold text-[#3D3530]">
                {drawing.name_ko}
              </h1>
              {drawing.description_ko && (
                <p class="mt-2 text-sm text-[#7A7067]">{drawing.description_ko}</p>
              )}
            </div>

            {/* Meta */}
            <div class="space-y-3">
              <div class="flex items-center gap-3 text-sm">
                <span class="text-[#A09890]">{g.difficulty}:</span>
                <span class={`px-2 py-0.5 rounded text-xs font-medium ${
                  drawing.difficulty === "easy" ? "bg-green-100 text-green-700" :
                  drawing.difficulty === "hard" ? "bg-red-100 text-red-700" :
                  "bg-yellow-100 text-yellow-700"
                }`}>
                  {diffLabels[drawing.difficulty] || drawing.difficulty}
                </span>
              </div>
              <div class="flex items-center gap-3 text-sm">
                <span class="text-[#A09890]">{g.age}:</span>
                <span class="text-[#3D3530]">{drawing.age_min}~{drawing.age_max}세</span>
              </div>
            </div>

            {/* Download buttons */}
            <div class="space-y-3">
              <a
                href={`${R2_URL}/${drawing.image_key}`}
                download={`ourcoloring_${subcategory.slug}_${drawing.slug}.png`}
                class="block w-full rounded-xl bg-gradient-to-r from-[#FF6B4A] to-[#FF8F6B] py-3.5 text-center font-bold text-white shadow-lg shadow-[#FF6B4A]/25 transition-all hover:scale-[1.02] active:scale-95"
                data-drawing-id={drawing.id}
                id="download-png-btn"
              >
                {g.downloadPng}
              </a>
              <button
                class="block w-full rounded-xl border-2 border-[#FF6B4A] py-3 text-center font-bold text-[#FF6B4A] transition-all hover:bg-[#FFF0E5] active:scale-95"
                id="download-pdf-btn"
                data-image-url={`${R2_URL}/${drawing.image_key}`}
                data-drawing-id={drawing.id}
                data-filename={`ourcoloring_${subcategory.slug}_${drawing.slug}`}
              >
                {g.downloadPdf}
              </button>
            </div>

            <p class="text-center text-sm text-[#A09890]">{g.printAndColor}</p>
          </div>
        </div>

        {/* Related drawings */}
        {relatedDrawings.length > 0 && (
          <section class="mt-12">
            <h2 class="font-['Nunito'] text-xl font-bold text-[#3D3530] mb-6">{g.relatedDrawings}</h2>
            <GalleryGrid>
              {relatedDrawings.map((d: Drawing) => (
                <DrawingCard
                  slug={d.slug}
                  name={d.name_ko}
                  thumbnailKey={d.thumbnail_key}
                  difficulty={d.difficulty}
                  categorySlug={category!.slug}
                  subcategorySlug={subcategory!.slug}
                  locale={locale}
                />
              ))}
            </GalleryGrid>
          </section>
        )}

        {/* Structured Data for SEO */}
        <script type="application/ld+json" set:html={JSON.stringify({
          "@context": "https://schema.org",
          "@type": "ImageObject",
          name: drawing.name_ko,
          description: drawing.description_ko || `${drawing.name_ko} 색칠공부 도안`,
          contentUrl: `${R2_URL}/${drawing.image_key}`,
          thumbnailUrl: `${R2_URL}/${drawing.thumbnail_key}`,
        })} />

        {/* Download tracking + PDF generation */}
        <script is:inline>
          (function() {
            function trackDownload(id) {
              fetch('/api/gallery/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id }),
              }).catch(function() {});
            }

            var pngBtn = document.getElementById('download-png-btn');
            if (pngBtn) {
              pngBtn.addEventListener('click', function() {
                trackDownload(pngBtn.dataset.drawingId);
              });
            }

            var pdfBtn = document.getElementById('download-pdf-btn');
            if (pdfBtn) {
              pdfBtn.addEventListener('click', async function() {
                pdfBtn.textContent = '준비 중...';
                pdfBtn.disabled = true;
                try {
                  var jspdf = await import('/jspdf/jspdf.es.min.js').catch(function() {
                    return import('jspdf');
                  });
                  var jsPDF = jspdf.jsPDF || jspdf.default?.jsPDF || jspdf.default;

                  var img = new Image();
                  img.crossOrigin = 'anonymous';
                  img.onload = function() {
                    var doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                    var pageW = 210, pageH = 297, margin = 10;
                    var maxW = pageW - margin * 2, maxH = pageH - margin * 2 - 10;
                    var ratio = Math.min(maxW / img.width, maxH / img.height);
                    var w = img.width * ratio, h = img.height * ratio;
                    var x = (pageW - w) / 2, y = (pageH - h - 10) / 2;

                    doc.addImage(img, 'PNG', x, y, w, h);
                    doc.setFontSize(8);
                    doc.setTextColor(180);
                    doc.text('OurColoring.com', pageW / 2, pageH - 8, { align: 'center' });
                    doc.save(pdfBtn.dataset.filename + '.pdf');
                    trackDownload(pdfBtn.dataset.drawingId);
                    pdfBtn.textContent = 'PDF 다운로드 (A4)';
                    pdfBtn.disabled = false;
                  };
                  img.onerror = function() {
                    alert('이미지 로드에 실패했습니다.');
                    pdfBtn.textContent = 'PDF 다운로드 (A4)';
                    pdfBtn.disabled = false;
                  };
                  img.src = pdfBtn.dataset.imageUrl;
                } catch(e) {
                  alert('PDF 생성에 실패했습니다.');
                  pdfBtn.textContent = 'PDF 다운로드 (A4)';
                  pdfBtn.disabled = false;
                }
              });
            }
          })();
        </script>
      </div>
    )}

  </main>
</Layout>
